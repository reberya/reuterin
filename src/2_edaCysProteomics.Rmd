---
title: "2_edaCysProteomics"
author: "Ryan Rebernick"
date: "4/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages
```{r, warning=F, message=F}

library('plyr')
library('dplyr')
library('magrittr')
library('data.table')

library('limma')
library(cowplot)
library(ggplot2)
library(ggfortify)
library(matrixStats)
library(ComplexHeatmap)
library(circlize)


```

# Limma analysis of cystiene proteomics data

## Prepare proteomics data for incorporation into Limma

### Load cysteine proteomics data and merge by gene_site
```{r}

# Load
## experiment 1
p1 <- fread('~/Desktop/projects/reuterin/data/UMichigan_Hannah_HCT_Cys_SLC-ABPP.txt', data.table = F)
## experiment 2
p2 <- fread('~/Desktop/projects/reuterin/data/UMichigan_Hannah_HCT_DMF_Reut_Cys_SLC-ABPP.txt', data.table = F)

# Prepare for merging by labeling cols appropriately
## experiment 1
p1.merge <- p1[,c(6:21)]
temp <- c('gene_site', paste0('dmso_1.', 1:3), paste0('acrolein_1_5um.', 1:3), paste0('acrolein_1_25um.', 1:3), paste0('reuterin_1_50um.', 1:3), paste0('reuterin_1_100um.', 1:3))
p1.merge %<>% set_colnames(temp)
## experiment 2
p2.merge <- p2[,c(6:21)]
temp <- c('gene_site', paste0('dmso_2.', 1:3), paste0('dmf_2_25um.', 1:3), paste0('dmf_2_100um.', 1:3), paste0('reuterin_2_50um.', 1:3), paste0('reuterin_2_100um.', 1:3))
p2.merge %<>% set_colnames(temp)

# Average duplicate columns
## Experiment 1
p1.merge <- p1.merge
p1.merge <-  stats::aggregate(x=p1.merge,
                          by=list(p1.merge$gene_site),
                          FUN = mean) 
p1.merge %<>% mutate(gene_site = Group.1) %>% dplyr::select(-Group.1)
## Experiment 2
p2.merge <- p2.merge
p2.merge <-  stats::aggregate(x=p2.merge,
                          by=list(p2.merge$gene_site),
                          FUN = mean) 
p2.merge %<>% mutate(gene_site = Group.1) %>% dplyr::select(-Group.1)

# merge
p <- merge(p1.merge, p2.merge, by = 'gene_site')
p %<>% set_rownames(p$gene_site) %>% dplyr::select(-gene_site)


```


## PCA analysis 

#### PCA analysis without normalization
Heavily segregated by experiment throughout first 4 PCs
```{r}

# prepare dataframe for PCA plotting
## transpose
dat <- as.data.frame(t(p))
## label by experiment and group
dat %<>% mutate(group = sub('\\.[0-9]', '', rownames(dat))) %>%
  mutate(exp = c(rep('exp1', 15), rep('exp2', 15)))
## reorder
dat %<>% dplyr::select(group, exp, 1:(ncol(dat)-2))

# Plot PCA
set.seed(11)
autoplot(dat %>% dplyr::select(-group, -exp) %>% prcomp(),
         data = dat,
         colour = 'exp') +
  theme_cowplot(12)

# Plot PCA
set.seed(11)
autoplot(dat %>% dplyr::select(-group, -exp) %>% prcomp(),
         data = dat,
         colour = 'exp',
         x=3,
         y=4) +
  theme_cowplot(12)


```


## Caluclate competition ratios
```{r}

# averages
p.c <- p %>%
  mutate(dmso_1.avg = rowMeans(p %>% dplyr::select(dmso_1.1:dmso_1.3))) %>%
  mutate(dmso_2.avg = rowMeans(p %>% dplyr::select(dmso_2.1:dmso_2.3))) %>%
  mutate(acrolein_1_5.avg = rowMeans(p %>% dplyr::select(acrolein_1_5um.1:acrolein_1_5um.3))) %>%
  mutate(acrolein_1_25.avg = rowMeans(p %>% dplyr::select(acrolein_1_25um.1:acrolein_1_25um.3))) %>%
  mutate(reuterin_1_50.avg = rowMeans(p %>% dplyr::select(reuterin_1_50um.1:reuterin_1_50um.3))) %>%
  mutate(reuterin_1_100.avg = rowMeans(p %>% dplyr::select(reuterin_1_100um.1:reuterin_1_100um.3))) %>%
  mutate(dmso_2.avg = rowMeans(p %>% dplyr::select(dmso_2.1:dmso_2.3))) %>%
  mutate(dmf_2_25.avg = rowMeans(p %>% dplyr::select(dmf_2_25um.1:dmf_2_25um.3))) %>%
  mutate(dmf_2_100.avg = rowMeans(p %>% dplyr::select(dmf_2_100um.1:dmf_2_100um.3))) %>%
  mutate(reuterin_2_50.avg = rowMeans(p %>% dplyr::select(reuterin_2_50um.1:reuterin_2_50um.3))) %>%
  mutate(reuterin_2_100.avg = rowMeans(p %>% dplyr::select(reuterin_2_100um.1:reuterin_2_100um.3)))

# competition ratios
p.c %<>%
  mutate(acroletin_1_5.cr = dmso_1.avg/acrolein_1_5.avg) %>%
  mutate(acroletin_1_25.cr = dmso_1.avg/acrolein_1_25.avg) %>%
  mutate(reuterin_1_50.cr = dmso_1.avg/reuterin_1_50.avg) %>%
  mutate(reuterin_1_100.cr = dmso_1.avg/reuterin_1_100.avg) %>%
  mutate(dmf_2_25.cr = dmso_2.avg/dmf_2_25.avg) %>%
  mutate(dmf_2_100.cr = dmso_2.avg/dmf_2_100.avg) %>%
  mutate(reuterin_2_50.cr = dmso_2.avg/reuterin_2_50.avg) %>%
  mutate(reuterin_2_100.cr = dmso_2.avg/reuterin_2_100.avg) 


```

## Filter for competition ratios of interest and Heatmap
```{r}

# 
toPlot <- p.c %>%
  dplyr::filter(reuterin_1_50.cr > 2 |
                  reuterin_1_100.cr > 2 |
                  reuterin_2_50.cr > 2 |
                  reuterin_2_100.cr > 2) %>%
  dplyr::select(reuterin_1_50.cr, reuterin_2_50.cr, reuterin_1_100.cr, reuterin_2_100.cr, acroletin_1_5.cr, acroletin_1_25.cr, dmf_2_25.cr, dmf_2_100.cr)
  

# color function
col_fun = colorRamp2(c(0, 2, 4), c("white", 'white', "red"))


# Plot heatmap
Heatmap(toPlot,
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F,
        show_column_dend = F,
        show_row_names = T,
        row_names_gp = gpar(fontsize = 7),
        show_column_names = T,
        col = col_fun)
  

```




```{r}

# Divide values by the control average
p.a <- p %>% 
  mutate(dmso_1.avg = rowMeans(p %>% dplyr::select(dmso_1.1:dmso_1.3))) %>%
  mutate(dmso_2.avg = rowMeans(p %>% dplyr::select(dmso_2.1:dmso_2.3)))
for(x in 1:15){
  p.a[,x] <- (p.a[,x]/p.a$dmso_1.avg)
  }
for(x in 16:30){
  p.a[,x] <- (p.a[,x]/p.a$dmso_2.avg)
  }

# remove averages
p.a %<>% dplyr::select(-contains('avg'))


# Normalize data for integration with LImma
temp <- colnames(p)
p.a %<>%
  ## Z scores
  apply(., 1, scale) %>%
  ## clean df
  t() %>%
  as.data.frame() %>%
  set_colnames(temp)

# check normal distribution
hist(p.a$dmso_1.1, breaks = 90)
hist(p.a$dmso_1.2, breaks = 90)
hist(p.a$dmso_1.3, breaks = 90)

hist(p.a$dmso_2.1, breaks = 90)
hist(p.a$dmso_2.2, breaks = 90)
hist(p.a$dmso_2.3, breaks = 90)

hist(unlist(p.a), breaks = 100)
max(unlist(p.a))


```

## Limma
```{r}

# Create design table
design <- as.data.frame(c(rep(1,15), rep(2,15)))
rownames(design) <- colnames(p.a)
colnames(design) <- 'experiment'
design %<>%
  mutate(control = c(rep(1,3), rep(0,12), rep(1,3), rep(0,12))) %>%
  mutate(reuterin = ifelse(grepl('reut', rownames(.)), 1,0)) %>%
  mutate(dmf = ifelse(grepl('dmf', rownames(.)), 1, 0)) %>%
  mutate(acrolein = ifelse(grepl('acro', rownames(.)), 1, 0)) %>%
  as.matrix() 

# fit linear model
fit <- lmFit(p.a, design = design)

contr <- makeContrasts(control - reuterin, levels = colnames(coef(fit)))
contr

tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

top.table <- topTable(tmp, sort.by = "P", n = Inf)
head(top.table, 20)

View(top.table)




```

# Heatmap of top hits
```{r}

temp <- top.table %>% dplyr::filter(adj.P.Val < 0.03) %>% rownames()
toPlot <- p.c %>%
  dplyr::filter(rownames(.) %in% temp) %>%
  dplyr::select(reuterin_1_50.cr, reuterin_2_50.cr, reuterin_1_100.cr, reuterin_2_100.cr, acroletin_1_5.cr, acroletin_1_25.cr, dmf_2_25.cr, dmf_2_100.cr)
  

# color function
col_fun = colorRamp2(c(0, 2, 4), c("white", "red", 'blue'))


# Plot heatmap
Heatmap(toPlot,
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F,
        show_column_dend = F,
        show_row_names = T,
        row_names_gp = gpar(fontsize = 7),
        show_column_names = T,
        col = col_fun)

```

# Make heatmap of top 100 100um reuterin hits

```{r}

## experiment 2
p2 <- fread('~/Desktop/projects/reuterin/data/UMichigan_Hannah_HCT_DMF_Reut_Cys_SLC-ABPP.txt', data.table = F)

# select needed cols
cyst <- p2[,c(2,6,23,29,31, 10:21)]
colnames(cyst)[1:3] <- c('gene', 'gene_site', 'avg_cntrl', 'cr_DMF_100', 'cr_Reut_100')

# Change zero values to matrix min
sub <- as.matrix(cyst[,6:17])
vals <- unlist(sub)
vals <- vals[vals > 0]
sub[sub < 0.1] <- min(vals)
cyst[,6:17] <- sub

# There are duplicate measurements of gene_sites. To remove dups, determine the maximum sd from all groups and select the duplciate with the lowest maximum sd.
## compute group SDs
cyst %<>% 
  mutate(DMF_25uM_sd = rowSds(as.matrix(cyst[,6:8]))) %>% 
  mutate(DMF_100uM_sd = rowSds(as.matrix(cyst[,9:11]))) %>% 
  mutate(Reut_50uM_sd = rowSds(as.matrix(cyst[,12:14]))) %>% 
  mutate(Reut_100uM_sd = rowSds(as.matrix(cyst[,15:17])))
## select max sd and arrange by max sd
cyst %<>%
  mutate(maxsd = rowMaxs(as.matrix(cyst[,18:21]))) %>%
  arrange(maxsd) %>%
  dplyr::select(gene:Reut_100uM_3)
## remove duplicates based on sd ordering
cyst <- cyst[!duplicated(cyst$gene_site),]

# Compute CRs for each replicate
cyst[,6:17] <- cyst$avg_cntrl/cyst[,6:17]

# Look at difference between DMF and reuterin
cyst$dif <- cyst$`CR 100 Reut`-cyst$`CR 100 DMF`
cyst %<>% dplyr::filter(dif > 0.2)

# Filter for those CRs greater than the mean +3SD
mean2sd <- mean(cyst$`CR 100 Reut`) + 2*sd(cyst$`CR 100 Reut`)
cyst %<>% dplyr::filter(`CR 100 Reut` >= mean2sd) %>%
  arrange(-`CR 100 Reut`)

# remove 25/50
values <- cyst %>% dplyr::select(DMF_100uM_1:DMF_100uM_3, Reut_100uM_1:Reut_100uM_3)


# Scale
# temp<- colnames(values)
# values %<>% apply(., MARGIN = 1, FUN=scale) %>%
#   t() %>%
#   set_colnames(temp)


col_fun = colorRamp2(c( 0, 1.5, 2), c("white", 'orange', "red"))

Heatmap(values,
        col = col_fun,
        show_row_dend = F,
        show_column_dend = F,
        show_row_names = F,
        show_column_names = F,
        cluster_rows = F,
        cluster_columns = F,
        row_km_repeats = 100,
        # column_order = 1:15,
        # column_split = factor(
        #   rep(c('25um DMF', '100um DMF', '50um Reuterin', '100um Reuterin'), each=3),
        #   levels = c('25um DMF', '100um DMF', '50um Reuterin', '100um Reuterin')),
        column_split = factor(
          rep(c('100um DMF', '100um Reuterin'), each=3),
          levels = c('100um DMF','100um Reuterin')),
        width = unit(3, "cm"),
        height = unit(7, "cm"),
        column_title_gp = gpar(fontsize=6),
        column_title_rot = 90,
        heatmap_legend_param = list(title = "CR")
        )


```




